# mmCalculator – Mechanical & Manufacturing Calculator

© 2021–2026 mmKreutzef (aka Daiki.NIIMI) Licensed under the BSD 3-Clause License

[English](README.md) | [日本語](README.ja.md)

# 概要

本プロジェクトは，**数値計算・複素数演算・高精度数学関数**を備えた数式評価エンジンです。

電卓用途だけでなく，CAD・数式処理・現場や設計レベルでの関数電卓を想定しています。

Mathematicaに着想を得ているため，風味がしますが変数代入やシンボリック処理は意図的に実装していません。

---

## 細かいことは置いといて実例超特急

```txt
In [1] := (2+3)(4+5) + 2Pi
Out[1] := 51.28318530718

In [2] := hypot(3,4) + norm(3,4) + distance(0,0,3,4)
Out[2] := 15

In [3] := round(ln(E^5) + log10(1000) + log2(8), 10)
Out[3] := 11

In [4] := fma(10^16, 3, -10^16*3) + expm1(1) - (E-1)
Out[4] := 0

In [5] := sin(30)^2 + cos(30)^2
Out[5] := 1

In [6] := tan(45) + cot(Pi/4 rad) + sec(60deg) + csc(Pi/6 rad)
Out[6] := 6

In [7] := asin(0.5) + acos(0.5) + atan(1)
Out[7] := 135

In [8] := atan2(1,1) + atan2(1,-1) + atan2(-1,-1) + atan2(-1,1)
Out[8] := 360

In [9] :=Out[3]*Out[2]-Out[7]
Out[9] := 30

In [10] := %% / %
Out[10] := 12

In [11] := 3!^2/%
Out[11] := 1

In [12] := (-8)^(1/3)
Out[12] := 1+1.732050807569I

In [13] := exp(I Pi) + 1
Out[13] := 0

In [14] := polar(2,60) + cis(60)
Out[14] := 1.5+2.598076211353I

In [15] := abs(%) + arg(%) + re(%) + im(%)
Out[15] := 67.098076211353

In [16] := conj(%%) + unit(%%) - proj(%%)
Out[16] := 0.5-4.330127018922I

In [17] := mean(3,5,7,11,13,17) + median(1,3,5) + mode(1,2,2,3)
Out[17] := 14.3333333333333

In [18] := stddevs(3,5,7,11,13,17) + vars(1,2,3) + iqr(1,2,3,4)
Out[18] := 7.778888771954

In [19] := gcd(84,120) + lcm(6,8) + perm(10,3) + comb(10,3)
Out[19] := 876

In [20] := isprime(67280421310721) + fib(25)/75025 + %%%%%%%%%
Out[20] := 3
```

### 要点超特急

- 暗黙乗算あるよ(自然入力)
- `%`や`Out[n]`で過去履歴を計算に使えるよ
- 複素に対応
- 角度は度数法が既定だけど`rad`などで指定できよ
- 関数・定数がいっぱい！
- CLIだけでなくUI版もあるよ！

# 詳細な内部事情

### 数値型

- **実数** IEEE754 double ±1.7E308(ただし表示は12桁)
- **複素数** `a + bI`

---

### 定数

すべて大文字で始まる

| 名前  | 説明                | 展開値                                  |
| ----- | ------------------- | --------------------------------------- |
| `Pi`  | 円周率              | `3.14159265358979323846264338327950288` |
| `Tau` | 2Pi (τ)             | `6.283185307179586476925286766559006`   |
| `E`   | 自然対数の底        | `2.7182818284590452353602874713526625`  |
| `Phi` | 黄金比              | `1.618033988749894848204586834365638`   |
| `NA`  | アボガドロ定数      | `6.02214076e23`                         |
| `I`   | 虚数単位            | `0+I`                                   |
| `ESP` | 内部収束誤差(1e-12) | `1e-12`                                 |

---

### 演算子

#### 四則・冪・階乗

| 演算子 | 説明               | 結合規則   |
| ------ | ------------------ | ---------- |
| `+ -`  | 加減算             | 左結合     |
| `* /`  | 乗除算             | 左結合     |
| `^`    | 冪乗               | **右結合** |
| `!`    | 階乗(非負整数のみ) | 後置       |

```text
2^3^2 = 2^(3^2)
-2^2 = -(2^2)
```

---

### 単項演算

- 単項 `+` `-` は任意回数連続可能

```text
---5 = -5
```

---

### 暗黙の乗算

以下のパターンは **自動的に乗算** として解釈される：

```text
2Pi
2(Pi)
Pi(2)
(2+3)(4+5)
(1+2)3(4+5)6
2 4
```

ただし，以下のような入力には留意せよ

| 入力    | 電卓の思考1  | 結果                            | 予想された結果(または入力ミス) |
| ------- | ------------ | ------------------------------- | ------------------------------ |
| `1..1`  | `1. .<-???`  | `Error: multiple '.' in number` | `1. * .1 = 0.1`                |
| `1.2.1` | `1.2 .<-???` | `Error: multiple '.' in number` | `1.2 * .1 = 0.12`              |

**関数名と数値は暗黙結合しない**

```text
【NG】
sin30 (Error)
sin2(30) (Error)

【OK】
sin(30)
cos(15+30)
```

必ず関数は`()`または`[]`で括ってください

---

### 関数

以下は現在実装されている全関数の一覧である。
関数名・概要・代表的な入力と出力例を示す。

---

### 基本数学(代数・指数・対数・丸め)

| 関数名           | 説明                 | 入力と出力例                     |
| ---------------- | -------------------- | -------------------------------- |
| `abs(x)`         | 絶対値(複素数対応)   | `abs(-3) = 3`<br>`abs(3+4I) = 5` |
| `sign(x)`        | 符号関数             | `sign(-5) = -1`<br>`sign(0) = 0` |
| `sqrt(x)`        | 平方根(負数は複素数) | `sqrt(4) = 2`<br>`sqrt(-4) = 2I` |
| `cbrt(x)`        | 立方根               | `cbrt(8) = 2`                    |
| `exp(x)`         | 指数関数             | `exp(1) = 2.71828...`            |
| `expm1(x)`       | `exp(x)-1`           | `expm1(1)=1.71828...`            |
| `log(x)`,`ln(x)` | 自然対数             | `log(E) = 1`                     |
| `log(b, x)`      | 任意底対数           | `log(10, 1000) = 3`              |
| `log10(x)`       | 常用対数             | `log10(100) = 2`                 |
| `log2(x)`        | 底2対数              | `log2(8) = 3`                    |
| `log1p(x)`       | `log(1+x)`           | `log1p(E-1)=1`                   |
| `floor(x)`       | 切り下げ             | `floor(3.7) = 3`                 |
| `ceil(x)`        | 切り上げ             | `ceil(3.1) = 4`                  |
| `trunc(x)`       | ゼロ方向丸め         | `trunc(-1.9)=-1`                 |
| `round(x)`       | 四捨五入             | `round(2.6) = 3`                 |
| `round(x,n)`     | n桁丸め              | `round(1.2345,2)=1.23`           |
| `fract(x)`       | 小数部分             | `fract(3.14)=0.14`               |
| `fact(x)`        | 階乗                 | `fact(10)=3628800`               |
| `mod(x,y)`       | 剰余                 | `mod(11,3)=2`                    |

---

### 特殊関数

| 関数名      | 説明          | 入力と出力例         |
| ----------- | ------------- | -------------------- |
| `gamma(x)`  | ガンマ関数    | `gamma(5)=24`        |
| `lgamma(x)` | logガンマ関数 | `lgamma(5)=3.178...` |
| `erf(x)`    | 誤差関数      | `erf(1)=0.842...`    |
| `erfc(x)`   | 相補誤差関数  | `erfc(1)=0.157...`   |

---

#### 角度変換

| 関数名    | 説明             | 入力と出力例    |
| --------- | ---------------- | --------------- |
| `DtoR(x)` | Degree -> Radian | `DtoR(180)=Pi`  |
| `DtoG(x)` | Degree -> Grad   | `DtoG(90)=100`  |
| `RtoD(x)` | Radian -> Degree | `RtoD(Pi)=180`  |
| `RtoG(x)` | Radian -> Grad   | `RtoG(Pi)=200`  |
| `GtoD(x)` | Grad -> Degree   | `GtoD(200)=180` |
| `GtoR(x)` | Grad -> Radian   | `GtoR(200)=Pi`  |

---

### 三角関数(角度制 / degree)

| 関数名       | 説明           | 入力と出力例    |
| ------------ | -------------- | --------------- |
| `sin(x)`     | 正弦           | `sin(30)=0.5`   |
| `cos(x)`     | 余弦           | `cos(60)=0.5`   |
| `tan(x)`     | 正接           | `tan(45)=1`     |
| `cot(x)`     | 余接           | `cot(45)=1`     |
| `sec(x)`     | 正割           | `sec(60)=2`     |
| `csc(x)`     | 余割           | `csc(30)=2`     |
| `asin(x)`    | 逆正弦         | `asin(0.5)=30`  |
| `acos(x)`    | 逆余弦         | `acos(0.5)=60`  |
| `atan(x)`    | 逆正接         | `atan(1)=45`    |
| `atan2(y,x)` | 象限付き逆正接 | `atan2(1,1)=45` |

---

### 双曲線関数

| 関数名     | 説明                             | 入力と出力例          |
| ---------- | -------------------------------- | --------------------- |
| `sinh(x)`  | 双曲線正弦                       | `sinh(1)=1.175...`    |
| `cosh(x)`  | 双曲線余弦                       | `cosh(0)=1`           |
| `tanh(x)`  | 双曲線正接                       | `tanh(0)=0`           |
| `asinh(x)` | 逆双曲線正弦                     | `asinh(1)=0.881...`   |
| `acosh(x)` | 逆双曲線余弦                     | `acosh(1)=0`          |
| `atanh(x)` | 逆双曲線正接                     | `atanh(0.5)=0.549...` |
| `csch(x)`  | 双曲線余割関数 `1/sinh(x)`       | `csch(1)=0.8509...`   |
| `sech(x)`  | 双曲線正割関数 `1/cosh(x)`       | `sech(0)=1`           |
| `coth(x)`  | 双曲線余接関数 `cosh(x)/sinh(x)` | `coth(1)=1.313...`    |

---

### 特殊比関数(c 系 / degree)

| 関数名     | 説明           | 入力と出力例           |
| ---------- | -------------- | ---------------------- |
| `sinc(x)`  | `sin(x)/x`     | `sinc(90)=0.111...`    |
| `cosc(x)`  | `(1-cos(x))/x` | `cosc(60)=0.008333...` |
| `tanc(x)`  | `tan(x)/x`     | `tanc(0)=1`            |
| `sinhc(x)` | `sinh(x)/x`    | `sinhc(3)=3.339...`    |
| `tanhc(x)` | `tanh(x)/x`    | `tanhc(30)=0.03333...` |
| `expc(x)`  | `(exp(x)-1)/x` | `expc(1)=1.7182818...` |

- sin/cos/tanがdegree前提なので，これらもdegree入力
- `x`が非常に小さいときは桁落ち対策が入る

---

### 数論・組合せ

| 関数名         | 説明                              | 入力と出力例                |
| -------------- | --------------------------------- | --------------------------- |
| `gcd(a,b,...)` | 最大公約数                        | `gcd(12,18,24)=6`           |
| `lcm(a,b,...)` | 最小公倍数                        | `lcm(6,8)=24`               |
| `perm(n,r)`    | 順列 (r<0 又は r>nのとき0)        | `perm(5,2)=20`              |
| `comb(n,r)`    | 組合せ (r<0 又は r>nのとき0)      | `comb(5,2)=10`              |
| `isprime(x)`   | 素数判定<br>(0: 合成数 / 1: 素数) | `isprime(67280421310721)=1` |
| `nextprime(n)` | _n_ 超過の最小の素数              | `nextprime(10) = 11`        |
| `prevprime(n)` | _n_ 未満の最大の素数              | `prevprime(10) = 7`         |
| `fib(x)`       | フィボナッチ数列                  | `fib(25)=75025`             |

---

### 統計(記述統計・集約)

| 関数名                 | 説明                                    | 入力と出力例                                                                                                                                                                         |
| ---------------------- | --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `sum(...)`             | 合計                                    | `sum(1,2,3)=6`                                                                                                                                                                       |
| `mean(...)`,`ave(...)` | 平均                                    | `mean(1,2,3)=2`                                                                                                                                                                      |
| `min(...)`             | 最小値                                  | `min(3,1,2)=1`                                                                                                                                                                       |
| `max(...)`             | 最大値                                  | `max(3,1,2)=3`                                                                                                                                                                       |
| `prod(...)`            | 積(総積)                                | `prod(2,3,4)=24`                                                                                                                                                                     |
| `median(...)`          | 中央値                                  | `median(1,3,5)=3`                                                                                                                                                                    |
| `mode(...)`            | 最頻値                                  | `mode(1,2,2,3)=2`                                                                                                                                                                    |
| `percentile(p,...)`    | パーセンタイル                          | `percentile(50,1,3,5)=3`                                                                                                                                                             |
| `quantile(p,...)`      | 分位点(pは0～1)                         | `quantile(1/4,1,2,3,4,5,6,7)=2.5`                                                                                                                                                    |
| `var(x...)`            | 母分散(n で割る)                        | `var(1,2,3)=0.666666666667`                                                                                                                                                          |
| `vars(x...)`           | 不偏分散(n-1 で割る)                    | `vars(1,2,3)=1`                                                                                                                                                                      |
| `stddev(x...)`         | 標準偏差                                | `stddev(1,2,3)=0.816496580928`                                                                                                                                                       |
| `stddevs(x...)`        | 不偏標準偏差                            | `stddevs(1,2,3)=1`                                                                                                                                                                   |
| `geomean(...)`         | 幾何平均                                | `geomean(1,4,1/32)=0.5`                                                                                                                                                              |
| `harmmean(...)`        | 調和平均                                | `harmmean(1,2,6)=1.8`                                                                                                                                                                |
| `mad(...)`             | 中央絶対偏差(Median Absolute Deviation) | `mad(1,1,2,2,4)=1`                                                                                                                                                                   |
| `madR(...)`            | 平均絶対偏差(Mean Absolute Deviation)   | `madR(1,2,3)=0.666...`                                                                                                                                                               |
| `skew(...)`            | 歪度(分布の非対称性の指標)              | `skew(1,2,3,4,5)=0`(対称)<br>`skew(0,0,0,0,10) > 0`(右に裾が長い)<br>`skew(-10,0,0,0,0) < 0`(左に裾が長い)<br>`skew(-2,-1,0,1,2)=0`                                                  |
| `kurtp(...)`           | 母集団の超過尖度(正規分布 -> 0)         | `kurtp(-1,-0.5,0,0.5,1) < 0 (-1.3)`(裾が軽い)<br>`kurtp(0,0,0,0,0,10) >> 0`(裾が重い)<br>`kurtp(-2,-1,0,1,2) < 0`(一様分布っぽい)<br>`kurtp(0,0,0,0,0,-2,2) > 0`(外れ値の影響が強い) |
| `kurts(...)`           | 標本の超過尖度, `n\geq 5`               | `kurts(-1,-0.5,0,0.5,1)=-7.09`                                                                                                                                                       |
| `cv(...)`              | 変動係数 = stddev/mean                  | `cv(10,10,10)=0`                                                                                                                                                                     |
| `stderr(...)`          | 標準誤差 = stddev/sqrt(n), `n\geq 2`    | `stderr(1,2,3)=0.471...`                                                                                                                                                             |
| `zscore(x, mu, sigma)` | (x-mu)/sigma                            | `zscore(5,3,1)=2`                                                                                                                                                                    |
| `iqr(...)`             | Q3-Q1                                   | `iqr(1,2,3,4)=2`                                                                                                                                                                     |
| `trimmean(p,...)`      | pの割合を両側から捨てて平均             | `trimmean(0.2,1,2,100,3,4)=2.5`                                                                                                                                                      |
| `winsor(p,...)`        | pの割合を両側から丸める(winsorize)      | `winsor(0.2,1,2,100,3,4)=?`                                                                                                                                                          |

---

### 財務関数

| 関数名                                  | 説明                          | 入力と出力例                                  |
| --------------------------------------- | ----------------------------- | --------------------------------------------- |
| `fin_fv(rate,n,pmt)`                    | 将来価値 (FV)                 | `fin_fv(0.05,10,100)=1257.789...`             |
| `fin_pv(rate,nper,pmt)`                 | 現在価値 (PV)                 | `fin_pv(0.05,10,100)=772.173...`              |
| `fin_pmt(rate,nper,pv)`                 | 支払額 (PMT)                  | `fin_pmt(0.05,10,1000)=129.504...`            |
| `fin_total_payment(rate,nper,pv)`       | 支払総額                      | `fin_total_payment(0.05,10,1000)=1295.045...` |
| `fin_ppmt(rate,nper,per,pv)`            | 元金返済額 (PPMT, 期指定)     | `fin_ppmt(0.05,10,3,1000)=92.455...`          |
| `fin_ipmt(rate,nper,per,pv)`            | 利息返済額 (IPMT, 期指定)     | `fin_ipmt(0.05,10,3,1000)=37.049...`          |
| `fin_npv(rate,cf...)`                   | 正味現在価値 (NPV)            | `fin_npv(0.1,100,-50,-50)=12.021...`          |
| `fin_irr(cf...)`                        | 内部収益率 (IRR, Brent)       | `fin_irr(-100,50,60)=0.063...`                |
| `fin_rate(nper,pmt,pv)`                 | 利率計算 (RATE, Brent)        | `fin_rate(10,100,1000)=0.05`                  |
| `fin_nper(rate,pmt,pv)`                 | 期間計算 (NPER)               | `fin_nper(0.05,100,1000)=10`                  |
| `fin_cumipmt(rate,nper,pmt,start,end)`  | 指定期間の利息累計 (CUMIPMT)  | `fin_cumipmt(0.05,10,100,1,5)=210.562...`     |
| `fin_cumprinc(rate,nper,pmt,start,end)` | 指定期間の元金累計 (CUMPRINC) | `fin_cumprinc(0.05,10,100,1,5)=289.437...`    |
| `fin_effective_rate(nominal,npery)`     | 実効利率 (EFFECTIVE RATE)     | `fin_effective_rate(0.06,12)=0.061...`        |
| `fin_nominal_rate(effective,npery)`     | 名目利率 (NOMINAL RATE)       | `fin_nominal_rate(0.0617,12)=0.060...`        |
| `fin_cagr(start,end,n)`                 | 年平均成長率 (CAGR)           | `fin_cagr(1000,2000,10)=0.071...`             |

- `fin_irr`は負が強いと根を見つけられないことが有ります

---

### 相関・共分散・未分類(ToDo: 要整理)

| 関数名                    | 説明                                     | 入力と出力例                      |
| ------------------------- | ---------------------------------------- | --------------------------------- |
| `cov(x...,y...)`          | 共分散                                   | `cov(1,2,3,2,4,6)=0.666...`       |
| `corr(x...,y...)`         | 相関係数                                 | `corr(1,2,3,2,4,6)=1`             |
| `corrspearman(x...,y...)` | スピアマン相関(順位相関)                 | `corrspearman(1,2,3, 10,20,30)=1` |
| `numdiff(v)`              | 差分の二乗平均平方根で微分の大きさを評価 | `numdiff(1,3,6)=2.549509756796`   |
| `polylog(s, z)`           | 多重級数による polylog 計算(`\|z\|<1`)   | `polylog(2, 0.5)=0.582240526465`  |
| `totient(n)`              | Euler のトーシェント関数 φ(n)            | `totient(9)=6`                    |
| `fft(...)`                | FFT の振幅平均を返す                     | `fft(1,2,3)=3.154700538379`       |
| `ifft(...)`               | IFFTの振幅平均を返す                     | `ifft(1,2,3)=2`                   |
| `dft(...)`                | DFTの振幅平均を返す                      | `dft(1,2,3)=3.732`                |
| `hilbert(...)`            | Hilbert変換後の信号振幅平均を返す        | `hilbert(1,2,3)=1`                |

- 本来ベクトルで受け取るべきものについて，本プログラムが多価にまだ対応していないため簡易版(平均値を返す)である

---

### 数値計算(浮動小数点ユーティリティ)

| 関数名       | 説明                   | 入力と出力例       |
| ------------ | ---------------------- | ------------------ |
| `hypot(x,y)` | √(x²+y²)(桁落ちに強い) | `hypot(3,4)=5`     |
| `fma(a,b,c)` | a\*b+c を1回丸めで計算 | `fma(10,10,2)=102` |
| `rms(...)`   | 二乗平均平方根         | `rms(1,-1,1,-1)=1` |

---

### 複素

| 関数名                              | 説明                            | 例                     |
| ----------------------------------- | ------------------------------- | ---------------------- |
| `re(z)`, `real(z)`                  | 実部                            | `re(3+4I)=3`           |
| `im(z)`, `imag(z)`                  | 虚部                            | `im(3+4I)=4`           |
| `arg(z)`                            | 偏角(度)                        | `arg(1+I)=45`          |
| `conj(z)`                           | 複素共役                        | `conj(3+4I)=3-4I`      |
| `polar(r,theta)`<br>`rect(r,theta)` | 極形式 r∠θ(θは度)               | `polar(2,60)=1+1.732I` |
| `cis(x)`                            | cos(x) + i sin(x)(xは度)        | `cis(60)=0.5+0.866I`   |
| `mag(z)`                            | `abs(z)` の同義(大きさ `\|z\|`) | `mag(3+4I)=5`          |
| `proj(z)`                           | リーマン球面への射影            | `proj(3+4I)=3+4I`      |
| `unit(z)`, `csgn(z)`                | 単位複素数 `z/abs(z)`(複素sign) | `unit(3+4I)=0.6+0.8I`  |

---

#### 幾何・ベクトル(2D)

| 関数名                  | 説明        | 入力と出力例          |
| ----------------------- | ----------- | --------------------- |
| `norm(x,y)`             | ベクトル長  | `norm(3,4)=5`         |
| `dot(x1,y1,x2,y2)`      | 内積        | `dot(1,0,0,1)=0`      |
| `cross(x1,y1,x2,y2)`    | 外積(Z成分) | `cross(1,0,0,1)=1`    |
| `lerp(a,b,t) `          | 線形補間    | `lerp(0,10,0.5)=5`    |
| `distance(x1,y1,x2,y2)` | 距離        | `distance(0,0,3,4)=5` |

---

### 乱数

| 関数名             | 説明                                 | 入力と出力例                       |
| ------------------ | ------------------------------------ | ---------------------------------- |
| `rand()`           | 乱数 \[0,1)                          | `rand()=0.37...`                   |
| `rand(hi)`         | 乱数 \[0,5)                          | `rand(5)=3.37...` ただし0のとき0   |
| `rand(lo,hi)`      | 乱数 \[lo,hi)                        | `rand(-2,2)=-0.71...`              |
| `randint()`        | 乱数 0 or 1                          | `randint()=0`                      |
| `randint(a)`       | 乱数 \[0,a\] `a>0`<br> \[a,0\] `a<0` | `randint(5)=2`                     |
| `randint(a,b)`     | 乱数 \[a,b\]                         | `randint(1,6)=3` サイコロ          |
| `choice(a, b,...)` | 1つ抽出                              | `choice(2,3,5,7,9,11,13,17,19)=17` |
| `randn()`          | 正規乱数 N(0,1)                      | `randn()=-0.23...`                 |
| `randn(mu)`        | 正規乱数 N(mu,1)                     | `randn(10)=9.61...`                |
| `randn(mu,sigma)`  | 正規乱数 N(mu,sigma)                 | `randn(0,2)=1.74...`               |

---

### 面積・体積

| 関数名                                | 説明                           | 入力と出力例                      |
| ------------------------------------- | ------------------------------ | --------------------------------- |
| `area_circle(d)`                      | 円の面積（直径指定）           | `area_circle(2)=3.14159...`       |
| `area_triangle(b,h)`                  | 三角形の面積(底辺と高さ)       | `area_triangle(3,4)=6`            |
| `area_triangle(a,b,c)`                | 三角形の面積(3辺の長さ)        | `area_triangle(3,4,5)=6`          |
| `area_trapezoid(a,b,h)`               | 台形の面積                     | `area_trapezoid(3,5,4)=16`        |
| `area_polygon(x0,y0,x1,y1,...,xn,yn)` | 多角形の面積（座標指定）       | `area_polygon(0,0,1,0,1,1,0,1)=1` |
| `vol_cylinder(d,h)`                   | 円柱の体積（直径指定）         | `vol_cylinder(2,3)=9.42477...`    |
| `vol_cone(d,h)`                       | 円錐の体積（直径指定）         | `vol_cone(2,3)=3.14159...`        |
| `vol_sphere(d)`                       | 球の体積（直径指定）           | `vol_sphere(2)=4.18879...`        |
| `vol_prism(x0,y0,...,xn,yn,h)`        | 底面多角形＋高さのプリズム体積 | `vol_prism(0,0,1,0,1,1,0,1,2)=2`  |

---

### 材料力学(応力・ひずみ・弾性)

| 関数名             | 説明           | 例                        |
| ------------------ | -------------- | ------------------------- |
| `stress(F,A)`      | 応力 σ=F/A     | `stress(1000,10)=100`     |
| `strain(dL,L)`     | ひずみ ε=dL/L  | `strain(0.1,100)=0.001`   |
| `young(sigma,eps)` | ヤング率 E=σ/ε | `young(200,0.001)=200000` |

---

### 断面特性(I, Z, J)

| 関数名                 | 説明                | 例                             |
| ---------------------- | ------------------- | ------------------------------ |
| `moment_rect(b,h)`     | 矩形断面 I=b\*h³/12 | `moment_rect(10,20)=6666.6`    |
| `moment_circle(d)`     | 円断面 I=π\*d⁴/64   | `moment_circle(10)=490.87`     |
| `sectionmod_rect(b,h)` | 矩形断面 Z=b\*h²/6  | `sectionmod_rect(10,20)=666.6` |
| `sectionmod_circle(d)` | 円断面 Z=π\*d³/32   | `sectionmod_circle(10)=98.17`  |
| `torsion_J_circle(d)`  | 円断面 J=π\*d⁴/32   | `torsion_J_circle(10)=981.74`  |
| `polarZ_circle(d)`     | 円断面 Zp=π\*d³/16  | `polarZ_circle(10)=196.35`     |

---

### 締結・摩擦(ボルト・トルク)

| 関数名                       | 説明                   | 例                                       |
| ---------------------------- | ---------------------- | ---------------------------------------- |
| `bolt_stress(F,d)`           | ボルト応力 σ=F/(πd²/4) | `bolt_stress(10000,10)=127.3`            |
| `torque_from_preload(F,d,K)` | 締付けトルク T=KFd     | `torque_from_preload(10000,0.01,0.2)=20` |
| `preload_from_torque(T,d,K)` | 逆変換 F=T/(Kd)        | `preload_from_torque(20,0.01,0.2)=10000` |
| `friction(mu,N)`             | 摩擦力 F=μN            | `friction(0.2,100)=20`                   |

---

### 金型・射出成形

| 関数名                                            | 説明                               | 入力例                                                               | 出力単位（MKS準拠） |
| ------------------------------------------------- | ---------------------------------- | -------------------------------------------------------------------- | ------------------- |
| `mold_clamp(P_avg, A_proj)`                       | 型締力（クランプ力）               | `mold_clamp(5e6, 0.01)=50000`                                        | N (kg·m/s²)         |
| `mold_clamp_safe(SF, P_avg, A_proj)`              | 安全率込みの型締力                 | `mold_clamp_safe(1.2, 5e6, 0.01)=60000`                              | N                   |
| `mold_Pinj(P_cav, ΔP_runner, ΔP_gate, ΔP_nozzle)` | 射出圧                             | `mold_Pinj(50e6, 1e6, 0.2e6, 0.1e6)=51300000`                        | Pa (kg/m·s²)        |
| `mold_flowrate(V, t_fill)`                        | 充填流量（体積流量）               | `mold_flowrate(0.0001, 0.5)=0.0002`                                  | m³/s                |
| `mold_gate_velocity(Q, A_gate)`                   | ゲート流速                         | `mold_gate_velocity(2e-4, 2e-5)=10`                                  | m/s                 |
| `mold_shear_gate(Q, b, h)`                        | 矩形ゲートのせん断速度             | `mold_shear_gate(2e-4, 0.002, 0.001)=60000`                          | 1/s                 |
| `mold_shear_runner(Q, D)`                         | ランナー円管のせん断速度           | `mold_shear_runner(2e-4, 0.004)=31830.988...`                        | 1/s                 |
| `mold_pressure_loss_runner(mu, L, Q, D)`          | ランナー圧損（ニュートン流体近似） | `mold_pressure_loss_runner(500, 0.2, 2e-4, 0.004)=3183098861.837...` | Pa                  |
| `mold_eject_friction(mu, N)`                      | 離型摩擦力                         | `mold_eject_friction(0.2, 1e4)=200`                                  | N                   |
| `mold_eject_contact(p_contact, A_contact)`        | 押し付け力                         | `mold_eject_contact(5e6, 0.002)=10000`                               | N                   |
| `mold_eject_total(mu, p_contact, A_contact)`      | 総合離型力                         | `mold_eject_total(0.2, 5e6, 0.002)=2000`                             | N                   |
| `mold_mu_tex(k, h)`                               | シボによる摩擦補正係数             | `mold_mu_tex(0.5, 0.001)=0.0005`                                     | 無次元              |
| `mold_pin_stress(F_eject, n, A_pin)`              | エジェクタピンの面圧               | `mold_pin_stress(1000, 4, 1e-6)=250000000`                           | Pa                  |
| `mold_plate_deflection(K, P, a, E, t)`            | 金型プレートの最大たわみ           | `mold_plate_deflection(0.005, 5e6, 0.2, 2e11, 0.01)=0.0002`          | m                   |

- 実験的実装である。今後，自明で不要な関数の削除および単位系に変動の可能性がある。

---

### ユーティリティ

| 関数名             | 説明  | 入力と出力例                  |
| ------------------ | ----- | ----------------------------- |
| `clamp(x, lo, hi)` | Clamp | `clamp(5,0,10)=5`             |
| `cnst("name")`     | 定数  | `cnst("celeritas")=299792458` |

定数一覧はこちら-> [【定数一覧】](constants_list.md)

---

### 履歴

| 関数名    | 説明              | 入力と出力例 |
| --------- | ----------------- | ------------ |
| `In[n]`   | n番目の入力再評価 | `In(1)`      |
| `Out[n]`  | n番目の出力       | `Out(1)`     |
| `Prev[k]` | k手前の出力       | `Prev(1)`    |
| `%`       | 手前の出力        | `%`          |
| `%%..`    | %の個数手前の出力 | `%%%%`       |

`%` -> 直前の出力
`%%` -> 1つ前の出力
`%%%` -> 2つ前の出力

---

#### システム関数

| 関数名    | 説明                                               |
| --------- | -------------------------------------------------- |
| `Clear[]` | Clearは履歴を消去し，`In[n] / Out[n]`を`n=1`にする |
| `Exit[]`  | プログラム終了                                     |

---

## 演算子優先順位表

以下に，本エンジンにおける**演算子の優先順位(高->低)**を示す。

| 優先度 | 演算子 / 構文  | 種別     | 結合規則   | 例                  |
| ------ | -------------- | -------- | ---------- | ------------------- |
| 1      | `!`            | 階乗     | 後置       | `3! = 6`            |
| 2      | 単項 `+ -`     | 単項演算 | 右結合     | `--5 = 5`           |
| 3      | `^`            | 冪乗     | **右結合** | `2^3^2 = 512`       |
| 4      | 暗黙の乗算     | 乗算     | 左結合     | `2Pi`, `(2+3)(4+5)` |
| 5      | `* /`          | 乗除算   | 左結合     | `10/2*3 = 15`       |
| 6      | `+ -`          | 加減算   | 左結合     | `1-2-3 = -4`        |
| 7      | `< <= > >= ==` | 比較     | 左結合     | `2 < 3 = 1`         |

### 優先順位に関する補足

- `!` は **最優先の後置演算子**である
- 単項演算子は冪乗よりも優先されますが，冪乗は右結合である
- 暗黙の乗算は明示的な `* /` よりも高い優先度を持つ
- 比較演算子は常に最後に評価される

---

### 比較演算子

| 演算子      | 意味     |
| ----------- | -------- |
| `< <= > >=` | 大小比較 |
| `==`        | 等価比較 |

- 結果は **1 (true) / 0 (false)**

---

### 複素数仕様

- `sqrt(-1) = I`
- `exp(I)` は Euler 形式
- 実数と複素数は自動昇格
- `+0I, -0I`はともにゼロとして評価される。故に`arg(-1+0I)=180`であり，`arg(-1-0I)=180`をそれぞれ得られる

---

### エラー仕様

以下は明示的に **Error** として扱われる：

- 括弧不整合
- 引数数不正
- 定義域外または無限大(`log(-1)`, `tan(90)` など)
- 不正構文(`2**3`, `1+*2` など)

---

#### エラー 一覧

| エラータイプ                               | ケース例                                                                                                                                 | コメント                                                     |
| ------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| **Division by zero**                       | `1/0`, `0/0`, `I/0`, `mod(1,0)`                                                                                                          | 0で割る操作で発生                                            |
| **Syntax error**                           | `1+*2`, `1/`, `()`, `(()`, `(`, `)`                                                                                                      | 演算式の構文不正                                             |
| **Domain error**                           | `log(0)`, `(-1)!`, `1.5!`, `preload_from_torque(1,0,0.2)`,<br> `bolt_stress(1,0)`, `trimmean(0.5,1,2,3,4)`, `stddevs(1)`, `kurts(1,2,3)` | 定義域外の計算(負の階乗、平方根負数、統計関数の要素不足など) |
| **Unknown identifier**                     | `foo`, `foo(1)`, `unknown(1)`, `cnst("")`, `cnst("GFN")`                                                                                 | 未定義関数や定数                                             |
| **Result is infinite**                     | `tan(90)`, `cot(0)`, `sec(90)`, `csc(0)`, `atanh(1)`, `atanh(-1)`, `log(0+0I)`                                                           | 計算結果が無限大になる                                       |
| **Result is NaN**                          | `0^I`, `(-0)^I`                                                                                                                          | 定義できない数値計算                                         |
| **History out of range**                   | `Out[0]`, `Out[-100]`, `Out[100]`                                                                                                        | 履歴アクセスの範囲外                                         |
| **Multiple '.' in number**                 | `1..1`                                                                                                                                   | 数字表記の構文エラー                                         |
| **Unknown constant / unterminated string** | `cnst(")`, `cnst("GFN)`                                                                                                                  | 定数名が未定義、または文字列終了していない                   |
| **Double or complex type error**           | `var(1,I)`, `median(1,I)`                                                                                                                | 許可されていない型による計算                                 |
| **Error in log with base**                 | `log(0,10)`, `log(1,0)`                                                                                                                  | 対数の底が不正                                               |
| **Overflow detected**                      | `fib(-1)`                                                                                                                                | 計算範囲外                                                   |
| **Other domain-related**                   | `acos(2)`, `asin(2)`, `acosh(0.5)`, `atan2(0,0)`, `log1p(-1)`, `log1p(-2)`                                                               | 三角関数・ログなどの定義域外                                 |

#### エラー動作の方針

- エラー発生時，それ以降の評価は行われない
- エラーは値として伝播せず，直ちに表示される

# 注意点・設計思想

## 角度制について

- 三角関数はすべて **degree** である。
  計算機科学等ではradなどが都合が良いが，一般性を重視しDegreeを既定としている。

以下のように明示した場合はradianを指定できる。

```text
sin(Pi/2 rad) = 1
```

---

## 数値精度

- 内部は `double` ベース
- ±1.7E308の範囲しか扱えません。範囲を超えた場合はオーバーフローまたは無限大のエラーを出力する。

- IEEE754 に起因する誤差あり

```text
atan(0.57735026919) = 30.000000000016
5.9722e24 =  5972200000000000224395264
```

ただし，表示は小数12桁に丸め込まれ，履歴保持時は15桁で保存され演算に用いられるため，上記のように目立つ例は僅かだ。

```text
0.1 + 0.2 - 0.3
純粋なdouble: 0.00000000000000006
12桁区切り : 0
```

### 未実装／意図的制限

- 変数代入なし
- ユーザー定義関数なし
- シンボリック演算なし

---

### 既知の挙動

- `0^-1` -> `±inf`(IEEE754 準拠)
- `-0` が表示される場合あり
- `In[], Out[]`の`[]`内に数式を入れた場合は未定義

---

### 仕様の挙動

- 空白は原則無視されますが，数値間では暗黙乗算として処理される。`3 2` -> `3*2`
- 原則複素解がある場合は複素で返すが，`cbrt`は実数解を返す。(`(-8)^(1/3)=1+1.732050807569I`, `cbrt(-8)=-2`)

---

## 文法定義(Extended Backus–Naur Form)

以下は本エンジンの構文を表す

```ebnf
(* トークン定義(抽象化) *)
digit         ::= "0" | "1" |  ... | "9" ;
letter        ::= "A" | ... | "Z" | "a" | ... | "z" ;
underscore    ::= "_" ;
identifier    ::= (letter | underscore) , { letter | digit | underscore } ;
number        ::= integer | float ;
string        ::= '"' , { any_character_except_quote } , '"' ;
constant      ::= "Pi" | "E" | "Phi" | "I" ;
function_call ::= identifier "(" [ arguments ] ")" ;
arguments     ::= expression { "," expression } ;
integer       ::= digit { digit } ;
float         ::= digit { digit } "." digit { digit } ;

plus        ::= "+" ;  minus       ::= "-" ;
mul         ::= "*" ;  div         ::= "/" ;
pow         ::= "^" ;
lparen      ::= "(" ;  rparen      ::= ")" ;
lbracket    ::= "[" ;  rbracket    ::= "]" ;
comma       ::= "," ;  bang        ::= "!" ;
lt          ::= "<" ;  le          ::= "<=" ;
gt          ::= ">" ;  ge          ::= ">=" ;
eq          ::= "==";  percent     ::= "%";

(* 基本式 *)
Expression      ::= Term , { ( plus | minus ) , Term } ;
Term            ::= Factor , { ( mul | div | ImplicitMul ) , Factor } ;
Factor          ::= Unary ;
Unary           ::= [ plus | minus ] , Power ;
Power           ::= Postfix , [ pow , Unary ] ;
Postfix         ::= Primary , { bang } ;

Primary         ::=
    | number
    | string
    | constant
    | function_call
    | percent { percent }       (* history reference *)
    | identifier [ FunctionCallOrUnit ]
    | "(" , Expression , ")"
    | "[" , Expression , "]" ;

FunctionCallOrUnit ::=
    | "(" , [ Expression , { comma , Expression } ] , ")"
    | "[" , [ Expression , { comma , Expression } ] , "]"
    | UnitIdentifier ;

UnitIdentifier  ::= identifier ; (* 30deg, 45rad など *)

(* 暗黙乗算の概念をEBNFで抽象化 ※ In[n], Out[n], %, %% 等は lexer レベルで special token として処理される *)
ImplicitMul     ::= /* 記号なしで値同士が並ぶ場合 */ ;


(* 比較式 *)
Compare         ::= Expression , { ( lt | le | gt | ge | eq ) , Expression } ;
```

### 文法上の補足

- `^` は **右結合**
- `!` は最優先の後置演算子
- 暗黙乗算はトークン隣接ルールにより解決される(EBNF外仕様)
- 関数名と数値の直接結合は構文エラー

---

## 実行時引数

実行時引数に数式を受け取った場合は解を出力し，終了します。
履歴機能は使えません。

---

## UI版

CLIをUIラップしたものである。使い方はCLI版に同じ。
ただし，以下のランタイムを要する。

[.Net8 Runtime](https://dotnet.microsoft.com/ja-jp/download/dotnet/8.0)

---

## ライセンス

BSD 3-Clause

Copyright (c) 2021–2026 mmKreutzef

このソフトウェアを学術論文や商用製品で使用する場合，ドキュメントや出版物においてその旨を明記してください。

お知らせいただけると喜びます。

---

## テスト

本プロジェクトは **600の自動テスト**を含み，以下を網羅しています：

- 演算子優先順位と結合規則
- エラー処理
- 複素数演算
- 境界値・異常系

---

## 備考

本プロジェクトは、厳密な演算子意味論と実用的な数式評価の両立を目指しています。
また、設計者や製造現場において、どのような環境でも簡便に動作することを目的としています。

---

### **免責事項**

本ソフトウェアは，「現状のまま」提供され，商業的利用の適合性，特定目的への適合性，非侵害など，明示または黙示の保証は一切ありません。
著者または著作権者は，契約，不法行為，その他の理由で発生する，または発生したソフトウェアに関連するすべての請求，損害，またはその他の責任に対して，一切責任を負いません。

本ソフトウェアを使用することにより，ソフトウェアの使用に関して発生するすべてのリスクは自己責任であることを認め，自動的に同意したことになります。
著者は，データの損失，システムの不具合，その他ソフトウェアの使用によって生じた損害について一切責任を負いません。

---

### 謝辞

このツール開発のきっかけとなった過去の自分と，学びの園であった大学と教授殿，実使用環境として現職場に感謝の意を表します

---

# 要望等

githubに投げてください。加工現場や設計現場で必要なも，実装の提案等あれば大歓迎です🍀

---

### 将来のお話

- _N_ 進数(0xや0b, add(),shift())の対応
- AngleModeの対応(setAngle=RADIAN)
- `eval`における`expect`化
- 微積分
- 変数は意図的に対応してないが，`for`的なものは欲しいよね
- `plot`関数(グラフ描画)
- BigInt?(double依存につき大きな数値で下桁が荒い)
