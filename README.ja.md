# mm Calculator – Manufacturing-Oriented Mathematical Calculator

© 2021–2026 mmKreuzef (aka Daiki.NIIMI) Project mme
Licensed under the BSD 3-Clause License

[English](README.md) | [日本語](README.ja.md)

## 仕様書(Language Specification)

### 概要

本プロジェクトは，**数値計算・複素数演算・高精度数学関数**を備えた数式評価エンジンです。

電卓用途だけでなく，CAD・数式処理・現場や設計レベルでの関数電卓を想定しています。

Mathematicaに着想を得ているため，風味がしますが変数代入やシンボリック処理は意図的に実装していません。

---

### 数値型

- **実数** IEEE754 double(ただし表示は12桁)

- **複素数** `a + bI`

---

### 定数

すべて最初は大文字で始まります

| 名前 | 説明 |

|----|----|

| `Pi` | 円周率 |

| `Tue` | 2Pi (τ, tau)|

| `E` | 自然対数の底 |

| `Phi` | 黄金比 |

| `NA` | アボガドロ定数 |

| `I` | 虚数単位 |

| `ESP` | 内部収束誤差(1e-12) |

---

### 演算子

#### 四則・冪・階乗

| 演算子 | 説明 | 結合規則 |

| ------ | -------------------- | ---------- |

| `+ -` | 加減算 | 左結合 |

| `* /` | 乗除算 | 左結合 |

| `^` | 冪乗 | **右結合** |

| `!` | 階乗(非負整数のみ) | 後置 |

```text

2^3^2 = 2^(3^2)

-2^2 = -(2^2)

```

---

### 単項演算

- 単項 `+` `-` は任意回数連続可能

```text

---5 = -5

```

---

### 暗黙の乗算

以下のパターンは **自動的に乗算** として解釈されます：

```text

2Pi

2(Pi)

Pi(2)

(2+3)(4+5)

```

**関数名と数値の暗黙結合は禁止**

```text

【NG】

sin30 (Error)

sin2(30) (Error)



【OK】

sin(30)

cos(15+30)

```

必ず関数は()または[]で括ってください

---

### 関数

#### 基本数学関数

```text

abs, sign, sqrt, cbrt, exp, log

```

- `log(x)` : 自然対数

- `log(base, x)` : 任意底対数

---

#### 角度変換

```text

DtoR, DtoG, RtoD, RtoG

GtoD, GtoR

```

- D:Degree, R:Radian, G: Grad

- 入力値を出力側の角度に変換します

- `RtoD(Pi) = 180`

- `RtoG(4+10I) = 254.647908947033+636.619772367581I`

---

#### 三角関数(角度制 / degree)

```text

sin, cos, tan, cot, sec, csc

asin, acos, atan

```

- 入力・出力とも degree

- RtoD等で明示すれば他の角度単位も使えます

- 定義域外は Error (例： tan(90) -> Error: result is infinite)

---

#### 双曲線関数

```text

sinh, cosh, tanh

asinh, acosh, atanh

```

---

#### 数論・組合せ

```text

gcd, lcm

perm, comb

```

---

#### 集約・制御

```text

sum, mean, min, max

```

#### 履歴

```text

In[n], Out[n], %, %%, %%%...

```

#### システム関数

```text

Clear[], Exit[]

```

- Clearは履歴を消去し，`In[n] / Out[n]`が1に戻ります

- Exitはプログラム終了

---

## 演算子優先順位表

以下に，本エンジンにおける**演算子の優先順位（高→低）**を示します。

| 優先度 | 演算子 / 構文  | 種別     | 結合規則   | 例                  |
| ------ | -------------- | -------- | ---------- | ------------------- |
| 1      | `!`            | 階乗     | 後置       | `3! = 6`            |
| 2      | 単項 `+ -`     | 単項演算 | 右結合     | `--5 = 5`           |
| 3      | `^`            | 冪乗     | **右結合** | `2^3^2 = 512`       |
| 4      | 暗黙の乗算     | 乗算     | 左結合     | `2Pi`, `(2+3)(4+5)` |
| 5      | `* /`          | 乗除算   | 左結合     | `10/2*3 = 15`       |
| 6      | `+ -`          | 加減算   | 左結合     | `1-2-3 = -4`        |
| 7      | `< <= > >= ==` | 比較     | 左結合     | `2 < 3 = 1`         |

### 優先順位に関する補足

- `!` は **最優先の後置演算子**です
- 単項演算子は冪乗よりも優先されますが，冪乗は右結合です
- 暗黙の乗算は明示的な `* /` よりも高い優先度を持ちます
- 比較演算子は常に最後に評価されます

---

### 比較演算子

| 演算子 | 意味 |

| -------------- | -------- |

| `< <= > >=` | 大小比較 |

| `==` | 等価比較 |

- 結果は **1 (true) / 0 (false)**

---

### 複素数仕様

- `sqrt(-1) = I`

- `exp(I)` は Euler 形式

- 実数と複素数は自動昇格

---

### エラー仕様

以下は明示的に **Error** として扱われます：

- 括弧不整合

- 引数数不正

- 定義域外(`log(-1)`, `tan(90)` など)

- 不正構文(`2**3`, `1+*2` など)

---

#### エラー一覧

| 分類         | 内容                                 | 例                       | 表示されるエラー                        |
| ------------ | ------------------------------------ | ------------------------ | --------------------------------------- |
| 構文エラー   | トークンの並びが不正                 | `2**3`, `1+*2`, `sin(,)` | `syntax error`                          |
| 括弧エラー   | 括弧の不整合                         | `(1+2`, `1+2)`           | `syntax error`                          |
| 引数数エラー | 関数の引数数が不正                   | `sin()`, `log(1,2,3)`    | `function argument missing`             |
| 型エラー     | 実数のみ許可される演算に複素数を指定 | `(-3)!`, `deg2rad(1+I)`  | `factorial: negative value`等           |
| 定義域エラー | 数学的に未定義                       | `log(-1)`, `tan(90)`     | `domain error`, `result is infinite` 等 |
| ゼロ除算     | 分母が 0                             | `1/0`, `10/(5-5)`        | `division by zero`                      |
| 未定義動作   | サポート外の構文                     | `sin30`, `PiPi`, `2**`   | `unknown identifier`等                  |

#### エラー動作の方針

- エラー発生時，それ以降の評価は行われません
- エラーは値として伝播せず，直ちに表示されます
- IEEE754 に基づく結果（`inf`, `-inf`）はエラーと区別されます
- `inf`, `-inf`を返すか`result is infinite`は曖昧です(要改修です)

---

## 使用方法

```text
In [1] := sin(30)^2 + cos(30)^2
Out[1] := 1

In [2] := sqrt(-4)
Out[2] := 2I

In [3] :=

In [3] := (2+3)(4+5)
Out[3] := 45

In [4] := 10/2+3
Out[4] := 8

In [5] := --3!-(-(3!))
Out[5] := 12

In [6] := gcd(8,4)
Out[6] := 4

In [7] := pow(4,0.5)
Out[7] := 2

In [8] := sin(90)
Out[8] := 1

In [9] := Out[3]+2
Out[9] := 47

In [10] := In[2+3]*5
Out[10] := 60


In [11] := %%
Out[11] := 47

In [12] := Clear[]

In [1] :=

```

---

## 注意点・設計思想

### 角度制について

- 三角関数はすべて **degree** です。計算機科学等ではradなどが都合が良いですが，一般性を重視しDegreeを既定としています。

- radian 非対応(将来拡張候補)

- 必要に応じてRtoD関数を使ってください

---

### 数値精度

- 内部は `double` ベース

- IEEE754 に起因する誤差あり

```text

atan(0.57735026919) = 30.000000000016

```

ただし，表示および履歴保持時は小数12桁に丸め込まれるため，上記のように目立つ例は僅かです。

```text

0.1 + 0.2 - 0.3

純粋なdouble: 0.00000000000000006

12桁区切り : 0


```

### 未実装／意図的制限

- 変数代入なし

- ユーザー定義関数なし

- シンボリック演算なし

---

### 既知の挙動

- `0^-1` → `±inf`(IEEE754 準拠)

- `-0` が表示される場合あり

- `In[], Out[]`の`[]`内に数式を入れた場合は未定義

---

## 文法定義(EBNF)

以下は本エンジンの構文を表す **EBNF(Extended Backus–Naur Form)** です。

```ebnf

expression ::= comparison ;

comparison ::= additive
| additive ( ("<" | "<=" | ">" | ">=" | "==") additive ) ;

additive ::= multiplicative { ("+" | "-") multiplicative } ;

multiplicative ::= power { ("*" | "/") power | implicit_mul power } ;

implicit_mul ::= /* adjacency: number, constant, or '(' */ ;

power ::= unary [ "^" power ] ; // right associative

unary ::= { "+" | "-" } postfix ;

postfix ::= primary { "!" } ;

primary ::= number
| constant
| function_call
| "(" expression ")" ;
※ In[n], Out[n], %, %% 等は lexer レベルで special token として処理される

function_call ::= identifier "(" [ arguments ] ")" ;

arguments ::= expression { "," expression } ;

number ::= integer | float ;

constant ::= "Pi" | "E" | "Phi" | "I" ;

identifier ::= letter { letter | digit } ;

integer ::= digit { digit } ;

float ::= digit { digit } "." digit { digit } ;

letter ::= "A"…"Z" | "a"…"z" ;

digit ::= "0"…"9" ;

```

### 実行時引数

実行時引数に数式を受け取った場合は解を出力し，終了します。

履歴機能は使えません。

### 文法上の補足

- `^` は **右結合**

- `!` は最優先の後置演算子

- 暗黙乗算はトークン隣接ルールにより解決される(EBNF外仕様)

- 関数名と数値の直接結合は構文エラー

---

## ライセンス

BSD 3-Clause

Copyright (c) 2021–2026 mmKreutzef

このソフトウェアを学術論文や商用製品で使用する場合，ドキュメントや出版物においてその旨を明記してください。
お知らせいただけると喜びます。

---

## テスト

本プロジェクトは **300の自動テスト**を含み，以下を網羅しています：

- 演算子優先順位と結合規則

- エラー処理

- 複素数演算

- 境界値・異常系

---

## 備考

本プロジェクトは，厳密な演算子意味論と実用的な数式評価を両立させること，設計者や製造現場にてどのような環境でも簡便に動くことを目的として設計されています。

## 要望等

gitに投げてください
